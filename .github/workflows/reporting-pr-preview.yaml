---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

name: "ðŸ” PR Preview Reports"

# yamllint disable-line rule:truthy
on:
  pull_request:
    paths:
      - 'src/**/*.py'
      - 'tests/**/*.py'
      - '.github/workflows/reporting-*.yaml'
      - '.github/scripts/*.sh'
      - 'pyproject.toml'
      - 'uv.lock'

concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions: {}

jobs:
  verify:
    name: "Verify Configuration"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.parse-projects.outputs.matrix }}
      run_timestamp: ${{ steps.metadata.outputs.timestamp }}
      pr_number: ${{ steps.metadata.outputs.pr_number }}
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Checkout PR"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: "Generate run metadata"
        id: metadata
        shell: bash
        run: |
          timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          pr_number="${{ github.event.pull_request.number }}"

          echo "timestamp=$timestamp" >> "$GITHUB_OUTPUT"
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"

          {
            echo "## ðŸ” PR Preview Report Generation"
            echo ""
            echo "**PR:** #$pr_number"
            echo "**Started:** $timestamp"
            echo "**Run ID:** ${{ github.run_id }}"
            echo ""
            echo "> âš ï¸ Preview run - will not overwrite production"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      - name: "Verify PROJECTS_JSON variable"
        shell: bash
        run: |
          if [ -z "${{ vars.PROJECTS_JSON }}" ]; then
            echo "::error::PROJECTS_JSON variable is not set"
            exit 1
          fi
          echo "âœ… PROJECTS_JSON variable exists"

      - name: "Validate required secrets"
        shell: bash
        env:
          CLASSIC_READ_ONLY_PAT_TOKEN: >-
            ${{ secrets.CLASSIC_READ_ONLY_PAT_TOKEN }}
          LF_GERRIT_INFO_MASTER_SSH_KEY:
            ${{ secrets.LF_GERRIT_INFO_MASTER_SSH_KEY }}
        run: |
          validation_failed=false

          echo "ðŸ” Validating secrets for PR preview..."

          if [ -z "$CLASSIC_READ_ONLY_PAT_TOKEN" ]; then
            echo "::error::CLASSIC_READ_ONLY_PAT_TOKEN secret is not set"
            validation_failed=true
          else
            echo "âœ… CLASSIC_READ_ONLY_PAT_TOKEN: Present"
          fi

          if [ -z "$LF_GERRIT_INFO_MASTER_SSH_KEY" ]; then
            echo "::warning::SSH key not set (HTTPS fallback)"
          else
            echo "âœ… LF_GERRIT_INFO_MASTER_SSH_KEY: Present"
          fi

          if [ "$validation_failed" = true ]; then
            echo "::error::Secret validation failed"
            exit 1
          fi

          echo "âœ… Secrets validated"

      - name: "Parse and validate PROJECTS_JSON"
        id: parse-projects
        shell: bash
        run: |
          projects_json='${{ vars.PROJECTS_JSON }}'

          # Validate JSON
          if ! echo "$projects_json" | jq . > /dev/null 2>&1; then
            echo "::error::PROJECTS_JSON contains invalid JSON"
            exit 1
          fi

          if ! echo "$projects_json" | \
            jq -e 'type == "array"' > /dev/null; then
            echo "::error::PROJECTS_JSON must be an array"
            exit 1
          fi

          if ! echo "$projects_json" | \
            jq -e 'all(.project and .gerrit)' > /dev/null; then
            echo "::error::Must have 'project' and 'gerrit' fields"
            exit 1
          fi

          # Limit to 2 projects for PR previews to save resources
          projects_json=$(echo "$projects_json" | jq '.[0:2]')
          project_count=$(echo "$projects_json" | jq '. | length')

          echo "âœ… Processing $project_count project(s) for preview"

          matrix=$(echo "$projects_json" | jq -c '{include: .}')
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

          {
            echo "### Projects (Preview - Limited)"
            echo ""
            echo "**Processing:** $project_count project(s)"
            echo ""
            echo "$projects_json" | \
              jq -r '.[] | "- **\(.project):** `\(.gerrit)`"'
            echo ""
            echo "> ðŸ’¡ **Note:** First 2 projects in PR previews"
            echo "> Full reports run on production schedule."
          } >> "$GITHUB_STEP_SUMMARY"

  analyze:
    name: "${{ matrix.project }} (Preview)"
    needs: verify
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 60
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix: ${{ fromJSON(needs.verify.outputs.matrix) }}
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Checkout PR"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: "Clone Gerrit repos for ${{ matrix.project }}"
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/gerrit-clone-action@80b7e603ec8497cc00346d5dec9fae0f346b0548 # v0.1.9
        id: clone
        with:
          host: ${{ matrix.gerrit }}
          path-prefix: "./${{ matrix.gerrit }}"
          skip-archived: "true"
          threads: "4"
          clone-timeout: "600"
          retry-attempts: "3"
          retry-base-delay: "3.0"
          retry-max-delay: "60.0"
          use-https: "true"
          move-conflicting: "true"

      - name: "Set up SSH key for info-master"
        shell: bash
        env:
          SSH_KEY: ${{ secrets.LF_GERRIT_INFO_MASTER_SSH_KEY }}
        run: |
          if [ -z "$SSH_KEY" ]; then
            echo "::warning::SSH key not set, will use HTTPS"
            echo "SSH_AVAILABLE=false" >> "$GITHUB_ENV"
          else
            echo "ðŸ”‘ Configuring SSH key"
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh

            echo "$SSH_KEY" > ~/.ssh/gerrit_info_master
            chmod 600 ~/.ssh/gerrit_info_master

            cat >> ~/.ssh/config <<EOF
          Host gerrit.linuxfoundation.org
            HostName gerrit.linuxfoundation.org
            User modesevenindustrialsolutions
            Port 29418
            IdentityFile ~/.ssh/gerrit_info_master
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
            chmod 600 ~/.ssh/config

            echo "âœ… SSH configured"
            echo "SSH_AVAILABLE=true" >> "$GITHUB_ENV"
          fi

      - name: "Clone info-master repository"
        shell: bash
        run: |
          echo "ðŸ”— Cloning info-master repository"

          ssh_url="ssh://modesevenindustrialsolutions@"
          ssh_url="${ssh_url}gerrit.linuxfoundation.org:29418/"
          ssh_url="${ssh_url}releng/info-master"

          if [ "${SSH_AVAILABLE:-false}" = "true" ]; then
            echo "Attempting SSH clone..."
            if git clone "$ssh_url" ./info-master; then
              echo "âœ… Cloned via SSH"
            else
              echo "::warning::SSH failed, trying HTTPS"
              git clone \
                "https://gerrit.linuxfoundation.org/infra/releng/info-master" \
                ./info-master
              echo "âœ… Cloned via HTTPS"
            fi
          else
            echo "Using HTTPS clone..."
            git clone \
              "https://gerrit.linuxfoundation.org/infra/releng/info-master" \
              ./info-master
            echo "âœ… Cloned via HTTPS"
          fi

      - name: "Install uv"
        # yamllint disable-line rule:line-length
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7.1.2

      - name: "Set up Python"
        # yamllint disable-line rule:line-length
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: "3.11"

      - name: "Install dependencies"
        shell: bash
        run: uv sync --all-extras

      - name: "Generate preview for ${{ matrix.project }}"
        shell: bash
        env:
          JENKINS_HOST: ${{ matrix.jenkins }}
          CLASSIC_READ_ONLY_PAT_TOKEN:
            ${{ secrets.CLASSIC_READ_ONLY_PAT_TOKEN }}
          GITHUB_ORG: ${{ matrix.github }}
          SSH_AVAILABLE: ${{ env.SSH_AVAILABLE }}
        run: |
          project="${{ matrix.project }}"
          echo "ðŸ“Š Generating preview reports for $project"

          if [ -n "$JENKINS_HOST" ]; then
            echo "ðŸ”§ Jenkins: $JENKINS_HOST"
          fi

          if [ -n "$CLASSIC_READ_ONLY_PAT_TOKEN" ]; then
            echo "ðŸ”§ GitHub API integration enabled"
          fi

          uv run reporting-tool generate \
            --project "$project" \
            --repos-path "./${{ matrix.gerrit }}" \
            --output-dir "./reports" \
            --verbose

          echo "âœ… Preview reports generated for $project"

      - name: "Create report metadata"
        shell: bash
        env:
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          project="${{ matrix.project }}"
          report_dir="./reports/$project"

          if [ ! -d "$report_dir" ]; then
            echo "::error::Report directory not found: $report_dir"
            exit 1
          fi

          # Create metadata with PR context
          cat > "$report_dir/metadata.json" <<EOF
          {
            "project": "$project",
            "gerrit_server": "${{ matrix.gerrit }}",
            "jenkins_server": "${{ matrix.jenkins }}",
            "github_org": "${{ matrix.github }}",
            "generated_at": "${{ needs.verify.outputs.run_timestamp }}",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}",
            "workflow_run_attempt": "${{ github.run_attempt }}",
            "git_sha": "${{ github.event.pull_request.head.sha }}",
            "git_ref": "$PR_HEAD_REF",
            "pr_number": ${{ github.event.pull_request.number }},
            "pr_author": "${{ github.event.pull_request.user.login }}",
            "environment": "pr-preview"
          }
          EOF

          echo "âœ… Metadata created"

      - name: "Upload raw data artifacts"
        if: always()
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: pr-preview-raw-data-${{ matrix.project }}
          path: |
            ./reports/${{ matrix.project }}/report_raw.json
            ./reports/${{ matrix.project }}/config_resolved.json
            ./reports/${{ matrix.project }}/metadata.json
          retention-days: 30
          if-no-files-found: error
          compression-level: 9

      - name: "Upload preview artifacts"
        if: always()
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: pr-preview-reports-${{ matrix.project }}
          path: ./reports/${{ matrix.project }}/
          retention-days: 30
          if-no-files-found: error
          compression-level: 6

      - name: "Upload clone manifest"
        if: always()
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: pr-preview-clone-manifest-${{ matrix.project }}
          path: "./${{ matrix.gerrit }}/clone-manifest.json"
          retention-days: 30
          if-no-files-found: warn

  publish-preview:
    name: "Publish PR Preview"
    needs: [verify, analyze]
    if: always() && needs.verify.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 15
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Checkout PR branch for scripts"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: "Copy script from PR"
        shell: bash
        run: |
          mkdir -p /tmp/pr-scripts
          cp .github/scripts/generate-index.sh /tmp/pr-scripts/

      - name: "Checkout gh-pages"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Download all preview report artifacts"
        # yamllint disable-line rule:line-length
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          pattern: pr-preview-reports-*
          path: ./downloaded-reports
        continue-on-error: true

      - name: "Prepare PR preview directory"
        shell: bash
        run: |
          pr_number="${{ needs.verify.outputs.pr_number }}"
          echo "ðŸ“¦ Preparing PR preview for #$pr_number"

          # Create PR preview directory
          preview_dir="pr-preview/$pr_number"
          mkdir -p "$preview_dir"

          # Clean up old preview if it exists
          if [ -d "$preview_dir" ] && [ -n "$preview_dir" ]; then
            rm -rf "${preview_dir:?}"/*
          fi

          # Process each downloaded report
          report_count=0
          for artifact_dir in ./downloaded-reports/pr-preview-reports-*
          do
            if [ ! -d "$artifact_dir" ]; then
              continue
            fi

            project_name=$(basename "$artifact_dir" | \
              sed 's/^pr-preview-reports-//')
            slug=$(echo "$project_name" | tr '[:upper:]' '[:lower:]' | \
              sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//')

            echo "Processing: $project_name -> $slug"

            target_dir="$preview_dir/$slug"
            mkdir -p "$target_dir"

            # Copy report files
            [ -f "$artifact_dir/report.html" ] && \
              cp "$artifact_dir/report.html" "$target_dir/"
            [ -f "$artifact_dir/report_raw.json" ] && \
              cp "$artifact_dir/report_raw.json" "$target_dir/"
            [ -f "$artifact_dir/report.md" ] && \
              cp "$artifact_dir/report.md" "$target_dir/"
            [ -f "$artifact_dir/metadata.json" ] && \
              cp "$artifact_dir/metadata.json" "$target_dir/"

            report_count=$((report_count + 1))
            echo "  âœ… Prepared $project_name"
          done

          echo "REPORT_COUNT=$report_count" >> "$GITHUB_ENV"
          echo "PREVIEW_DIR=$preview_dir" >> "$GITHUB_ENV"
          echo "âœ… Prepared $report_count preview report(s)"

      - name: "Generate preview index page"
        shell: bash
        run: |
          # Create .nojekyll to disable Jekyll processing
          touch .nojekyll
          echo "âœ… Created .nojekyll file"
          
          pr_number="${{ needs.verify.outputs.pr_number }}"
          preview_dir="pr-preview/$pr_number"

          # Use the script from the PR branch (has latest fixes)
          bash /tmp/pr-scripts/generate-index.sh \
            "$preview_dir" "pr-preview"

      - name: "Commit and push preview"
        shell: bash
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          pr_number="${{ needs.verify.outputs.pr_number }}"
          preview_dir="pr-preview/$pr_number"

          git config user.name "lf-releng-reports-bot"
          git config user.email \
            "lf-releng+reports-bot@linuxfoundation.org"

          git add "$preview_dir"/
          git add pr-preview/index.html || true
          git add .nojekyll || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          cat > /tmp/commit-msg.txt <<EOF
          chore: add PR #$pr_number preview reports

          Generated: ${{ needs.verify.outputs.run_timestamp }}
          Reports: ${{ env.REPORT_COUNT }} project(s)
          PR: #$pr_number - $PR_TITLE
          Run: ${{ github.run_id }}
          EOF

          git commit -F /tmp/commit-msg.txt
          git push origin gh-pages

          repo_name="${{ github.event.repository.name }}"
          owner="${{ github.repository_owner }}"
          base_url="https://${owner}.github.io/${repo_name}"
          echo "PREVIEW_URL=${base_url}/${preview_dir}" >> "$GITHUB_ENV"
          echo "âœ… Published PR preview"

      - name: "Comment on PR with links"
        # yamllint disable-line rule:line-length
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const previewUrl = process.env.PREVIEW_URL;
            const reportCount = process.env.REPORT_COUNT;

            const serverUrl = '${{ github.server_url }}';
            const repo = '${{ github.repository }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `${serverUrl}/${repo}/actions/runs/${runId}`;
            const body = `## ðŸ” Report Preview Available

            Preview reports have been generated for this PR.

            **Reports generated:** ${reportCount} project(s)
            **Preview URL:** ${previewUrl}

            ### ðŸ“Š View Reports

            Visit the preview site to review generated reports.

            > âš ï¸ **Note:** Preview reports do not affect production.
            > Only the first 2 projects are processed.

            ---

            Generated from workflow run: [${runId}](${runUrl})`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Report Preview Available')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

  summary:
    name: "Generate Summary"
    needs: [verify, analyze, publish-preview]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Generate workflow summary"
        shell: bash
        run: |
          {
            echo "## ðŸ” PR Preview Generation Complete"
            echo ""
            echo "**PR:** #${{ github.event.pull_request.number }}"
            echo "**Completed:** $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""
            echo "### Job Results"
            echo ""
            echo "- **Verify:** ${{ needs.verify.result }}"
            echo "- **Analyze:** ${{ needs.analyze.result }}"
            echo "- **Publish Preview:** ${{ needs.publish-preview.result }}"
            echo ""
            echo "---"
            echo ""
            echo "âœ… Preview reports are available in the PR comments"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
