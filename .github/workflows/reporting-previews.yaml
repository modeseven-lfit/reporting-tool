---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

name: "üîç Preview Reports"

# yamllint disable-line rule:truthy
on:
  pull_request:
    paths:
      - 'src/**/*.py'
      - 'tests/**/*.py'
      - '.github/workflows/reporting-*.yaml'
      - '.github/scripts/*.sh'
      - 'pyproject.toml'
      - 'uv.lock'

concurrency:
  group: report-previews-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions: {}

jobs:
  verify:
    name: "Verify configuration"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.parse-projects.outputs.matrix }}
      run_timestamp: ${{ steps.metadata.outputs.timestamp }}
      pr_number: ${{ steps.metadata.outputs.pr_number }}
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Checkout pull request"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: "Generate run metadata"
        id: metadata
        shell: bash
        run: |
          timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          pr_number="${{ github.event.pull_request.number }}"

          echo "timestamp=$timestamp" >> "$GITHUB_OUTPUT"
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"

          {
            echo "## üîç Preview Report Generation"
            echo ""
            echo "**PR:** #$pr_number"
            echo "**Started:** $timestamp"
            echo "**Run ID:** ${{ github.run_id }}"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      - name: "Verify PROJECTS_JSON variable"
        shell: bash
        run: |
          if [ -z "${{ vars.PROJECTS_JSON }}" ]; then
            echo "::error::PROJECTS_JSON variable is not set"
            exit 1
          fi
          echo "‚úÖ PROJECTS_JSON variable exists"

      - name: "Validate required secrets"
        shell: bash
        env:
          CLASSIC_READ_ONLY_PAT_TOKEN: >-
            ${{ secrets.CLASSIC_READ_ONLY_PAT_TOKEN }}
          LF_GERRIT_INFO_MASTER_SSH_KEY:
            ${{ secrets.LF_GERRIT_INFO_MASTER_SSH_KEY }}
        run: |
          validation_failed=false

          echo "üîê Validating secrets for preview reports..."

          if [ -z "$CLASSIC_READ_ONLY_PAT_TOKEN" ]; then
            echo "::error::CLASSIC_READ_ONLY_PAT_TOKEN secret is not set"
            validation_failed=true
          else
            echo "‚úÖ CLASSIC_READ_ONLY_PAT_TOKEN: Present"
          fi

          if [ -z "$LF_GERRIT_INFO_MASTER_SSH_KEY" ]; then
            echo "::warning::SSH key not set (HTTPS fallback)"
          else
            echo "‚úÖ LF_GERRIT_INFO_MASTER_SSH_KEY: Present"
          fi

          if [ "$validation_failed" = true ]; then
            echo "::error::Secret validation failed"
            exit 1
          fi

          echo "‚úÖ Secrets validated"

      - name: "Parse and validate PROJECTS_JSON"
        id: parse-projects
        shell: bash
        run: |
          projects_json='${{ vars.PROJECTS_JSON }}'

          # Validate JSON
          if ! echo "$projects_json" | jq . > /dev/null 2>&1; then
            echo "::error::PROJECTS_JSON contains invalid JSON"
            exit 1
          fi

          if ! echo "$projects_json" | \
            jq -e 'type == "array"' > /dev/null; then
            echo "::error::PROJECTS_JSON must be an array"
            exit 1
          fi

          if ! echo "$projects_json" | \
            jq -e 'all(.project and .gerrit)' > /dev/null; then
            echo "::error::Must have 'project' and 'gerrit' fields"
            exit 1
          fi

          # Limit to 2 projects for Preview reports to save resources
          projects_json=$(echo "$projects_json" | jq '.[0:2]')
          project_count=$(echo "$projects_json" | jq '. | length')

          echo "‚úÖ Processing $project_count project(s) for preview"

          matrix=$(echo "$projects_json" | jq -c '{include: .}')
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

          {
            echo "### Projects (Preview - Limited)"
            echo ""
            echo "**Processing:** $project_count project(s)"
            echo ""
            echo "$projects_json" | \
              jq -r '.[] | "- **\(.project):** `\(.gerrit)`"'
            echo ""
            echo "> üí° **Note:** First 2 projects in Preview reports"
            echo "> Full reports run on production schedule."
          } >> "$GITHUB_STEP_SUMMARY"

  analyze:
    name: "${{ matrix.project }} (Preview)"
    needs: verify
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 60
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix: ${{ fromJSON(needs.verify.outputs.matrix) }}
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Checkout pull request"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: "Clone Gerrit repos for ${{ matrix.project }}"
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/gerrit-clone-action@80b7e603ec8497cc00346d5dec9fae0f346b0548 # v0.1.9
        id: clone
        with:
          host: ${{ matrix.gerrit }}
          path-prefix: "./${{ matrix.gerrit }}"
          skip-archived: "true"
          threads: "4"
          clone-timeout: "600"
          retry-attempts: "3"
          retry-base-delay: "3.0"
          retry-max-delay: "60.0"
          use-https: "true"
          move-conflicting: "true"

      - name: "Set up SSH key for info-master"
        shell: bash
        env:
          SSH_KEY: ${{ secrets.LF_GERRIT_INFO_MASTER_SSH_KEY }}
        run: |
          if [ -z "$SSH_KEY" ]; then
            echo "::warning::SSH key not set, will use HTTPS"
            echo "SSH_AVAILABLE=false" >> "$GITHUB_ENV"
          else
            echo "üîë Configuring SSH key"
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh

            echo "$SSH_KEY" > ~/.ssh/gerrit_info_master
            chmod 600 ~/.ssh/gerrit_info_master

            cat >> ~/.ssh/config <<EOF
          Host gerrit.linuxfoundation.org
            HostName gerrit.linuxfoundation.org
            User modesevenindustrialsolutions
            Port 29418
            IdentityFile ~/.ssh/gerrit_info_master
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
            chmod 600 ~/.ssh/config

            echo "‚úÖ SSH configured"
            echo "SSH_AVAILABLE=true" >> "$GITHUB_ENV"
          fi

      - name: "Clone info-master repository"
        shell: bash
        run: |
          echo "üîó Cloning info-master repository"

          ssh_url="ssh://modesevenindustrialsolutions@"
          ssh_url="${ssh_url}gerrit.linuxfoundation.org:29418/"
          ssh_url="${ssh_url}releng/info-master"

          if [ "${SSH_AVAILABLE:-false}" = "true" ]; then
            echo "Attempting SSH clone..."
            if git clone "$ssh_url" ./info-master; then
              echo "‚úÖ Cloned via SSH"
            else
              echo "::warning::SSH failed, trying HTTPS"
              git clone \
                "https://gerrit.linuxfoundation.org/infra/releng/info-master" \
                ./info-master
              echo "‚úÖ Cloned via HTTPS"
            fi
          else
            echo "Using HTTPS clone..."
            git clone \
              "https://gerrit.linuxfoundation.org/infra/releng/info-master" \
              ./info-master
            echo "‚úÖ Cloned via HTTPS"
          fi

      - name: "Install uv"
        # yamllint disable-line rule:line-length
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7.1.2

      - name: "Set up Python"
        # yamllint disable-line rule:line-length
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: "3.11"

      - name: "Install dependencies"
        shell: bash
        run: uv sync --all-extras

      - name: "Generate preview for ${{ matrix.project }}"
        shell: bash
        env:
          JENKINS_HOST: ${{ matrix.jenkins }}
          CLASSIC_READ_ONLY_PAT_TOKEN:
            ${{ secrets.CLASSIC_READ_ONLY_PAT_TOKEN }}
          GITHUB_ORG: ${{ matrix.github }}
          SSH_AVAILABLE: ${{ env.SSH_AVAILABLE }}
        run: |
          project="${{ matrix.project }}"
          echo "üìä Generating preview reports for $project"

          if [ -n "$JENKINS_HOST" ]; then
            echo "üîß Jenkins: $JENKINS_HOST"
          fi

          if [ -n "$CLASSIC_READ_ONLY_PAT_TOKEN" ]; then
            echo "üîß GitHub API integration enabled"
          fi

          uv run reporting-tool generate \
            --project "$project" \
            --repos-path "./${{ matrix.gerrit }}" \
            --output-dir "./reports" \
            --github-token-env CLASSIC_READ_ONLY_PAT_TOKEN \
            --verbose

          echo "‚úÖ Preview reports generated for $project"

      - name: "Create report metadata"
        shell: bash
        env:
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          project="${{ matrix.project }}"
          report_dir="./reports/$project"

          if [ ! -d "$report_dir" ]; then
            echo "::error::Report directory not found: $report_dir"
            exit 1
          fi

          # Create metadata with pull request context
          cat > "$report_dir/metadata.json" <<EOF
          {
            "project": "$project",
            "gerrit_server": "${{ matrix.gerrit }}",
            "jenkins_server": "${{ matrix.jenkins }}",
            "github_org": "${{ matrix.github }}",
            "generated_at": "${{ needs.verify.outputs.run_timestamp }}",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}",
            "workflow_run_attempt": "${{ github.run_attempt }}",
            "git_sha": "${{ github.event.pull_request.head.sha }}",
            "git_ref": "$PR_HEAD_REF",
            "pr_number": ${{ github.event.pull_request.number }},
            "pr_author": "${{ github.event.pull_request.user.login }}",
            "environment": "previews"
          }
          EOF

          echo "‚úÖ Metadata created"

      - name: "Upload raw data artifacts"
        if: always()
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: previews-raw-data-${{ matrix.project }}
          path: |
            ./reports/${{ matrix.project }}/report_raw.json
            ./reports/${{ matrix.project }}/config_resolved.json
            ./reports/${{ matrix.project }}/metadata.json
          retention-days: 30
          if-no-files-found: error
          compression-level: 9

      - name: "Upload preview artifacts"
        if: always()
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: previews-reports-${{ matrix.project }}
          path: ./reports/${{ matrix.project }}/
          retention-days: 30
          if-no-files-found: error
          compression-level: 6

      - name: "Upload clone manifest"
        if: always()
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: previews-clone-manifest-${{ matrix.project }}
          path: "./${{ matrix.gerrit }}/clone-manifest.json"
          retention-days: 30
          if-no-files-found: warn

  publish-preview:
    name: "Publish preview reports"
    needs: [verify, analyze]
    if: always() && needs.verify.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 15
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Checkout pull request branch for scripts"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: "Copy script from pull request"
        shell: bash
        run: |
          mkdir -p /tmp/pr-scripts
          cp .github/scripts/generate-index.sh /tmp/pr-scripts/

      - name: "Checkout gh-pages branch"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Download all preview artifacts"
        # yamllint disable-line rule:line-length
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          pattern: previews-reports-*
          path: ./downloaded-reports
        continue-on-error: true

      - name: "Prepare preview directory"
        shell: bash
        run: |
          pr_number="${{ needs.verify.outputs.pr_number }}"
          echo "üì¶ Preparing Preview report for #$pr_number"

          # Create Preview report directory
          preview_dir="previews/$pr_number"
          mkdir -p "$preview_dir"

          # Clean up old preview if it exists
          if [ -d "$preview_dir" ] && [ -n "$preview_dir" ]; then
            rm -rf "${preview_dir:?}"/*
          fi

          # Process each downloaded report
          report_count=0
          for artifact_dir in ./downloaded-reports/previews-reports-*
          do
            if [ ! -d "$artifact_dir" ]; then
              continue
            fi

            project_name=$(basename "$artifact_dir" | \
              sed 's/^previews-reports-//')
            slug=$(echo "$project_name" | tr '[:upper:]' '[:lower:]' | \
              sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//')

            echo "Processing: $project_name -> $slug"

            target_dir="$preview_dir/$slug"
            mkdir -p "$target_dir"

            # Copy report files
            [ -f "$artifact_dir/report.html" ] && \
              cp "$artifact_dir/report.html" "$target_dir/"
            [ -f "$artifact_dir/report_raw.json" ] && \
              cp "$artifact_dir/report_raw.json" "$target_dir/"
            [ -f "$artifact_dir/report.md" ] && \
              cp "$artifact_dir/report.md" "$target_dir/"
            [ -f "$artifact_dir/metadata.json" ] && \
              cp "$artifact_dir/metadata.json" "$target_dir/"

            report_count=$((report_count + 1))
            echo "  ‚úÖ Prepared $project_name"
          done

          echo "REPORT_COUNT=$report_count" >> "$GITHUB_ENV"
          echo "PREVIEW_DIR=$preview_dir" >> "$GITHUB_ENV"
          echo "‚úÖ Prepared $report_count preview report(s)"

      - name: "Generate preview index page"
        shell: bash
        run: |
          # Create .nojekyll to disable Jekyll processing
          touch .nojekyll
          echo "‚úÖ Created .nojekyll file"

          pr_number="${{ needs.verify.outputs.pr_number }}"
          preview_dir="previews/$pr_number"

          # Use the script from the PR branch (has latest fixes)
          bash /tmp/pr-scripts/generate-index.sh \
            "$preview_dir" "previews"

      - name: "Generate parent previews index"
        shell: bash
        run: |
          echo "üìÑ Generating parent previews index"

          # Create previews directory if it doesn't exist
          mkdir -p previews

          # Find all preview directories
          preview_dirs=()
          if [ -d "previews" ]; then
            for pr_dir in previews/*/; do
              if [ -d "$pr_dir" ] && [ -f "$pr_dir/index.html" ]; then
                pr_num=$(basename "$pr_dir")
                # Only add if it's a number (PR number)
                if [[ "$pr_num" =~ ^[0-9]+$ ]]; then
                  preview_dirs+=("$pr_num")
                fi
              fi
            done
          fi

          # Sort preview directories (descending - newest first)
          sorted_dirs=()
          if [ ${#preview_dirs[@]} -gt 0 ]; then
            mapfile -t sorted_dirs < <(printf '%s\n' \
              "${preview_dirs[@]}" | sort -rn)
          fi

          echo "Found ${#sorted_dirs[@]} preview(s): ${sorted_dirs[*]}"

          # Generate the parent index HTML
          cat > previews/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport"
              content="width=device-width, initial-scale=1.0">
            <title>Preview Reports - Linux Foundation</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont,
                  'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg,
                  #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 2rem 1rem;
              }
              .container { max-width: 1200px; margin: 0 auto; }
              header {
                background: white;
                border-radius: 12px;
                padding: 2rem;
                margin-bottom: 2rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
              }
              h1 {
                font-size: 2.5rem;
                margin-bottom: 0.5rem;
                color: #2d3748;
              }
              .subtitle {
                font-size: 1.1rem;
                color: #718096;
                margin-bottom: 1rem;
              }
              .back-link {
                display: inline-block;
                color: #667eea;
                text-decoration: none;
                margin-top: 1rem;
                font-weight: 500;
              }
              .back-link:hover { text-decoration: underline; }
              main {
                background: white;
                border-radius: 12px;
                padding: 2rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
              }
              .preview-list {
                display: flex;
                flex-direction: column;
                gap: 1rem;
              }
              .preview-card {
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 1.5rem;
                transition: all 0.3s ease;
                background: #fafafa;
              }
              .preview-card:hover {
                border-color: #667eea;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
                transform: translateY(-2px);
              }
              .preview-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.5rem;
              }
              .preview-title {
                font-size: 1.25rem;
                font-weight: 600;
                color: #2d3748;
              }
              .preview-number {
                background: #667eea;
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.9rem;
                font-weight: 600;
              }
              .preview-meta {
                font-size: 0.9rem;
                color: #718096;
                margin-bottom: 1rem;
              }
              .preview-link {
                display: inline-block;
                background: #667eea;
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 500;
                transition: all 0.2s;
              }
              .preview-link:hover {
                background: #5568d3;
                transform: translateY(-1px);
              }
              .empty-state {
                text-align: center;
                padding: 4rem 2rem;
                color: #718096;
              }
              footer {
                text-align: center;
                padding: 2rem;
                color: white;
                margin-top: 2rem;
              }
              footer a { color: white; text-decoration: underline; }
            </style>
          </head>
          <body>
            <div class="container">
              <header>
                <h1>üîç Preview Reports</h1>
                <p class="subtitle">
                  Pull request preview reports for review
                </p>
                <a href="/reporting-tool/" class="back-link">
                  ‚Üê Back to Production Reports
                </a>
              </header>

              <main>
                <div class="preview-list">
          EOF

          # Add preview cards or empty state
          if [ ${#sorted_dirs[@]} -eq 0 ]; then
            cat >> previews/index.html <<'EOF'
                  <div class="empty-state">
                    <div style="font-size: 4rem;
                      margin-bottom: 1rem;">üì≠</div>
                    <h3>No Previews Available</h3>
                    <p>Preview reports will appear here when pull
                      requests are opened.</p>
                  </div>
          EOF
          else
            for pr_num in "${sorted_dirs[@]}"; do
              pr_dir="previews/$pr_num"

              # Count projects in this preview
              project_count=0
              if [ -d "$pr_dir" ]; then
                project_count=$(find "$pr_dir" -maxdepth 1 \
                  -type d ! -path "$pr_dir" | wc -l | tr -d ' ')
              fi

              # Generate card
              cat >> previews/index.html <<CARD
                  <div class="preview-card">
                    <div class="preview-header">
                      <div class="preview-title">Pull Request #${pr_num}</div>
                      <span class="preview-number">PR #${pr_num}</span>
                    </div>
                    <div class="preview-meta">
                      üìä ${project_count} project report(s) available
                    </div>
                    <a href="/reporting-tool/previews/${pr_num}/"
                      class="preview-link">
                      View Preview Reports ‚Üí
                    </a>
                  </div>
          CARD
            done
          fi

          # Close HTML
          cat >> previews/index.html <<'EOF'
                </div>
              </main>

              <footer>
                <p>
                  Generated by
                  <a href="https://github.com/modeseven-lfit/reporting-tool"
                    target="_blank">
                    Linux Foundation Reporting Tool
                  </a>
                </p>
                <p style="margin-top: 0.5rem;
                  font-size: 0.9rem;">
                  &copy; 2025 The Linux Foundation | Apache-2.0 License
                </p>
              </footer>
            </div>
          </body>
          </html>
          EOF

          pr_count="${#sorted_dirs[@]}"
          echo "‚úÖ Generated parent previews index with $pr_count preview(s)"

      - name: "Commit and push preview"
        shell: bash
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          pr_number="${{ needs.verify.outputs.pr_number }}"
          preview_dir="previews/$pr_number"

          git config user.name "lf-releng-reports-bot"
          git config user.email \
            "lf-releng+reports-bot@linuxfoundation.org"

          git add "$preview_dir"/
          git add previews/index.html || true  # Add parent index
          git add .nojekyll || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          cat > /tmp/commit-msg.txt <<EOF
          chore: add PR #$pr_number preview reports

          Generated: ${{ needs.verify.outputs.run_timestamp }}
          Reports: ${{ env.REPORT_COUNT }} project(s)
          PR: #$pr_number - $PR_TITLE
          Run: ${{ github.run_id }}
          EOF

          git commit -F /tmp/commit-msg.txt
          git push origin gh-pages

          repo_name="${{ github.event.repository.name }}"
          owner="${{ github.repository_owner }}"
          base_url="https://${owner}.github.io/${repo_name}"
          echo "PREVIEW_URL=${base_url}/${preview_dir}" >> "$GITHUB_ENV"
          echo "‚úÖ Published Preview report"

      - name: "Comment on pull request with links"
        # yamllint disable-line rule:line-length
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const previewUrl = process.env.PREVIEW_URL;
            const reportCount = process.env.REPORT_COUNT;

            const serverUrl = '${{ github.server_url }}';
            const repo = '${{ github.repository }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `${serverUrl}/${repo}/actions/runs/${runId}`;
            const body = `## üîç Preview Reports Available

            ${previewUrl}
            Workflow run: [${runId}](${runUrl})`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Reports Available')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

  summary:
    name: "Generate summary"
    needs: [verify, analyze, publish-preview]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Generate workflow summary"
        shell: bash
        run: |
          {
            echo "## üîç Preview Reports Complete"
            echo ""
            echo "**PR:** #${{ github.event.pull_request.number }}"
            echo "**Completed:** $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""
            echo "### Job Results"
            echo ""
            echo "- **Verify:** ${{ needs.verify.result }}"
            echo "- **Analyze:** ${{ needs.analyze.result }}"
            echo "- **Publish Preview:** ${{ needs.publish-preview.result }}"
            echo ""
            echo "‚úÖ Preview reports are available from pull request comments"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
