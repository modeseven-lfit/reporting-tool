---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

name: "ðŸ“Š Project Reports"

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  schedule:
    # Run every Monday at 7:00 AM UTC
    - cron: "0 7 * * 1"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  verify:
    name: "Verify Configuration"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.parse-projects.outputs.matrix }}
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Verify PROJECTS_JSON variable content"
        shell: bash
        run: |
          if [ -z "${{ vars.PROJECTS_JSON }}" ]; then
            echo "::error::PROJECTS_JSON variable is not set"
            exit 1
          fi

          echo "PROJECTS_JSON variable exists"
          echo "Raw content: ${{ vars.PROJECTS_JSON }}"

      - name: "Validate required secrets"
        shell: bash
        env:
          CLASSIC_READ_ONLY_PAT_TOKEN: >-
            ${{ secrets.CLASSIC_READ_ONLY_PAT_TOKEN }}
          GERRIT_REPORTS_PAT_TOKEN: >-
            ${{ secrets.GERRIT_REPORTS_PAT_TOKEN }}
          LF_GERRIT_INFO_MASTER_SSH_KEY: >-
            ${{ secrets.LF_GERRIT_INFO_MASTER_SSH_KEY }}
        run: |
          validation_failed=false

          echo "ðŸ” Validating required secrets..."

          # Check CLASSIC_READ_ONLY_PAT_TOKEN
          if [ -z "$CLASSIC_READ_ONLY_PAT_TOKEN" ]; then
            echo "::error::CLASSIC_READ_ONLY_PAT_TOKEN secret is" \
              "not set or is empty"
            echo "âŒ CLASSIC_READ_ONLY_PAT_TOKEN: MISSING"
            validation_failed=true
          else
            echo "âœ… CLASSIC_READ_ONLY_PAT_TOKEN: Present"
          fi

          # Check GERRIT_REPORTS_PAT_TOKEN
          if [ -z "$GERRIT_REPORTS_PAT_TOKEN" ]; then
            echo "::error::GERRIT_REPORTS_PAT_TOKEN secret is" \
              "not set or is empty"
            echo "âŒ GERRIT_REPORTS_PAT_TOKEN: MISSING"
            validation_failed=true
          else
            echo "âœ… GERRIT_REPORTS_PAT_TOKEN: Present"
          fi

          # Check LF_GERRIT_INFO_MASTER_SSH_KEY
          if [ -z "$LF_GERRIT_INFO_MASTER_SSH_KEY" ]; then
            echo "::warning::LF_GERRIT_INFO_MASTER_SSH_KEY secret is" \
              "not set or is empty"
            echo "âš ï¸  LF_GERRIT_INFO_MASTER_SSH_KEY: MISSING" \
              "(will fall back to HTTPS)"
          else
            echo "âœ… LF_GERRIT_INFO_MASTER_SSH_KEY: Present"
          fi

          # Write summary
          {
            echo "## ðŸ” Secrets Validation"
            echo ""
            if [ -n "$CLASSIC_READ_ONLY_PAT_TOKEN" ]; then
              echo "- âœ… **CLASSIC_READ_ONLY_PAT_TOKEN:** Present"
            else
              echo "- âŒ **CLASSIC_READ_ONLY_PAT_TOKEN:** MISSING"
            fi

            if [ -n "$GERRIT_REPORTS_PAT_TOKEN" ]; then
              echo "- âœ… **GERRIT_REPORTS_PAT_TOKEN:** Present"
            else
              echo "- âŒ **GERRIT_REPORTS_PAT_TOKEN:** MISSING"
            fi

            if [ -n "$LF_GERRIT_INFO_MASTER_SSH_KEY" ]; then
              echo "- âœ… **LF_GERRIT_INFO_MASTER_SSH_KEY:** Present"
            else
              echo "- âš ï¸ **LF_GERRIT_INFO_MASTER_SSH_KEY:** MISSING" \
                "(HTTPS fallback will be used)"
            fi
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$validation_failed" = true ]; then
            echo "::error::Secret validation failed - missing required secrets"
            exit 1
          fi

          echo "âœ… All required secrets are present"

      - name: "Parse and validate PROJECTS_JSON"
        id: parse-projects
        shell: bash
        run: |
          # Parse PROJECTS_JSON and verify structure
          projects_json='${{ vars.PROJECTS_JSON }}'

          # Validate JSON syntax
          if ! echo "$projects_json" | jq . > /dev/null 2>&1; then
            echo "::error::PROJECTS_JSON contains invalid JSON"
            exit 1
          fi

          # Validate required fields exist
          if ! echo "$projects_json" | jq -e 'type == "array"' > /dev/null; then
            echo "::error::PROJECTS_JSON must be an array"
            exit 1
          fi

          # Check each project has required fields
          if ! echo "$projects_json" | \
            jq -e 'all(.project and .gerrit)' > /dev/null; then
            echo "::error::Each project must have 'project' and 'gerrit' fields"
            exit 1
          fi

          # Count projects
          project_count=$(echo "$projects_json" | jq '. | length')
          echo "Found $project_count project(s) to process"

          # Create matrix for parallel execution
          matrix=$(echo "$projects_json" | jq -c '{include: .}')
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

          {
            echo "## Configuration Validation âœ…"
            echo "- **Projects found:** $project_count"
            echo "- **JSON structure:** Valid"
            echo ""
            echo "### Projects:"
          } >> "$GITHUB_STEP_SUMMARY"
          echo "$projects_json" | \
            jq -r '.[] | "- **\(.project):** \(.gerrit)"' >> \
            "$GITHUB_STEP_SUMMARY"

  analyze:
    name: "${{ matrix.project }}"
    needs: verify
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 60
    concurrency:
      group: publish-report-${{ matrix.project }}
      cancel-in-progress: false
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.verify.outputs.matrix) }}
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Clone Gerrit repositories for ${{ matrix.project }}"
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/gerrit-clone-action@80b7e603ec8497cc00346d5dec9fae0f346b0548 # v0.1.9
        id: clone
        with:
          host: ${{ matrix.gerrit }}
          path-prefix: "./${{ matrix.gerrit }}"
          skip-archived: "true"
          # LF Broadband struggles with load and operations can timeout
          # threads: ${{ matrix.project == 'LF Broadband' && '1' || '4' }}
          threads: "4"
          clone-timeout: "600"
          retry-attempts: "5"
          retry-base-delay: "3.0"
          retry-max-delay: "60.0"
          use-https: "true"
          # Enable move-conflicting to ensure 100% repository availability
          # for comprehensive data mining and reporting purposes
          move-conflicting: "true"

      - name: "Set up SSH key for Gerrit info-master"
        shell: bash
        env:
          SSH_KEY: ${{ secrets.LF_GERRIT_INFO_MASTER_SSH_KEY }}
        run: |
          if [ -z "$SSH_KEY" ]; then
            echo "::warning::LF_GERRIT_INFO_MASTER_SSH_KEY secret not set"
            echo "Will attempt HTTPS clone as fallback"
            echo "SSH_AVAILABLE=false" >> "$GITHUB_ENV"
          else
            echo "ðŸ”‘ Setting up SSH key for Gerrit operations"
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh

            # Write SSH key to file
            echo "$SSH_KEY" > ~/.ssh/gerrit_info_master
            chmod 600 ~/.ssh/gerrit_info_master

            # Configure SSH for gerrit.linuxfoundation.org
            cat >> ~/.ssh/config <<EOF
          Host gerrit.linuxfoundation.org
            HostName gerrit.linuxfoundation.org
            User modesevenindustrialsolutions
            Port 29418
            IdentityFile ~/.ssh/gerrit_info_master
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
            chmod 600 ~/.ssh/config

            echo "âœ… SSH key configured for gerrit.linuxfoundation.org"
            echo "SSH_AVAILABLE=true" >> "$GITHUB_ENV"
          fi

      - name: "Clone info-master repository"
        shell: bash
        # yamllint disable rule:line-length
        run: |
          echo "ðŸ”— Cloning info-master repository for additional context data"

          # Try SSH first if available, fall back to HTTPS
          if [ "${SSH_AVAILABLE:-false}" = "true" ]; then
            echo "Attempting SSH clone..."
            if git clone "ssh://modesevenindustrialsolutions@gerrit.linuxfoundation.org:29418/releng/info-master" ./info-master; then
              echo "âœ… Info-master repository cloned successfully via SSH"
            else
              echo "::warning::SSH clone failed, falling back to HTTPS"
              git clone "https://gerrit.linuxfoundation.org/infra/releng/info-master" ./info-master
              echo "âœ… Info-master repository cloned successfully via HTTPS"
            fi
          else
            echo "SSH not available, using HTTPS clone..."
            git clone "https://gerrit.linuxfoundation.org/infra/releng/info-master" ./info-master
            echo "âœ… Info-master repository cloned successfully via HTTPS"
          fi

          echo "ðŸ“ Sample files:"
          find ./info-master -maxdepth 1 -name "*.yaml" | head -3
          echo "ðŸ“‚ Sample directories:"
          find ./info-master -maxdepth 1 -type d \
            -name "gerrit.*" | head -3
        # yamllint enable rule:line-length

      - name: Install uv
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41
        # v7.1.2

      - name: "Set up Python environment for ${{ matrix.project }}"
        # yamllint disable-line rule:line-length
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        # v6.0.0
        with:
          python-version: "3.11"

      - name: "Install Python dependencies"
        shell: bash
        run: uv sync --all-extras

      - name: "Run comprehensive analytics for ${{ matrix.project }}"
        shell: bash
        env:
          JENKINS_HOST: ${{ matrix.jenkins }}
          # yamllint disable-line rule:line-length
          CLASSIC_READ_ONLY_PAT_TOKEN: ${{ secrets.CLASSIC_READ_ONLY_PAT_TOKEN }}
          GITHUB_ORG: ${{ matrix.github }}
          SSH_AVAILABLE: ${{ env.SSH_AVAILABLE }}
        run: |
          project="${{ matrix.project }}"
          echo "ðŸ“Š Starting comprehensive analytics for $project"

          # Debug: Show Jenkins host if provided
          if [ -n "$JENKINS_HOST" ]; then
            echo "ðŸ”§ Jenkins integration enabled for: $JENKINS_HOST"
          else
            echo "â„¹ï¸ No Jenkins host provided - Jenkins integration disabled"
          fi

          # Debug: Show GitHub token availability
          if [ -n "$CLASSIC_READ_ONLY_PAT_TOKEN" ]; then
            echo "ðŸ”§ GitHub API integration enabled"
           echo  "(CLASSIC_READ_ONLY_PAT_TOKEN)"
          else
            echo "â„¹ï¸ No CLASSIC_READ_ONLY_PAT_TOKEN provided"
            echo "âŒ GitHub API integration disabled"
          fi

          # Execute the comprehensive reporting system
          uv run reporting-tool generate \
            --project "$project" \
            --repos-path "./${{ matrix.gerrit }}" \
            --config-dir "./configuration" \
            --output-dir "./reports" \
            --verbose

          echo "âœ… Analytics completed successfully for $project"

      - name: "Debug artifact paths before upload"
        shell: bash
        run: |
          project="${{ matrix.project }}"
          echo "ðŸ” Debugging artifact paths for $project"

          echo "Current working directory:"
          pwd

          echo "Contents of ./reports/:"
          ls -la ./reports/ || echo "No reports directory found"

          echo "Contents of ./reports/$project/:"
          ls -la "./reports/$project/" \
            || echo "No project reports directory found"

          echo "Looking for clone manifest:"
          ls -la "./${{ matrix.gerrit }}/clone-manifest.json" \
            || echo "No clone manifest found"

          echo "All files in reports directory tree:"
          find ./reports -type f 2>/dev/null \
          || echo "No files found in reports"

      - name: "Upload clone manifest"
        if: always()
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        # v5.0.0
        with:
          name: clone-manifest-${{ matrix.project }}
          path: "./${{ matrix.gerrit }}/clone-manifest.json"
          retention-days: 14
          if-no-files-found: warn

      - name: "Upload gerrit clone log"
        if: always()
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        # v5.0.0
        with:
          name: gerrit-clone-log-${{ matrix.project }}
          path: "./${{ matrix.gerrit }}.log"
          retention-days: 14
          if-no-files-found: warn

      - name: "Upload analysis reports"
        if: always()
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        # v5.0.0
        with:
          name: reports-${{ matrix.project }}
          path: ./reports/${{ matrix.project }}/
          retention-days: 30
          if-no-files-found: error


  publish:
    name: "Publish Reports"
    needs: [verify, analyze]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 15
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Download report artifacts"
        # yamllint disable-line rule:line-length
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        # v6.0.0
        with:
          pattern: reports-*
          path: ./downloaded-reports
        continue-on-error: true

      - name: "Publish reports"
        env:
          REPORTS_TOKEN: ${{ secrets.GERRIT_REPORTS_PAT_TOKEN }}
          REPORTS_REPO: modeseven-lfit/gerrit-reports
          ARTIFACTS_DIR: ./downloaded-reports
        shell: bash
        run: |
          bash .github/scripts/publish-reports.sh

  summary:
    name: "Generate Summary"
    needs: [verify, publish]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    timeout-minutes: 10
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: "audit"

      - name: "Download all results"
        # yamllint disable-line rule:line-length
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        # v6.0.0
        with:
          pattern: reports-*
          path: ./results

      - name: "Generate workflow summary"
        shell: bash
        run: |
          {
            echo "## ðŸ“Š Project Reports Summary"
            echo ""
            echo "**Workflow completed:** $(date -u)"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # Count results
          result_count=$(find ./results -name "reports-*" \
            -type d 2>/dev/null | wc -l)
          {
            echo "**Reports generated:** $result_count project(s) processed"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # List processed projects
          if [ -d "./results" ]; then
            echo "### ðŸ“Š Generated Reports:" >> "$GITHUB_STEP_SUMMARY"
            for result_dir in ./results/reports-*; do
              if [ -d "$result_dir" ]; then
                project_name=$(basename "$result_dir" | sed 's/reports-//')
                echo "- âœ… **$project_name**" >> "$GITHUB_STEP_SUMMARY"
              fi
            done
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Job summary generated at run-time" >> "$GITHUB_STEP_SUMMARY"

      - name: "Update GitHub Pages"
        if: success()
        env:
          REPORTS_TOKEN: >-
            ${{ secrets.GERRIT_REPORTS_PAT_TOKEN }}
          REPORTS_REPO: modeseven-lfit/gerrit-reports
        shell: bash
        run: |
          if [ -z "${REPORTS_TOKEN}" ]; then
            echo "::warning::GERRIT_REPORTS_PAT_TOKEN secret" \
              "not set; cannot trigger pages workflow."
            echo "Pages will need to be updated manually."
            exit 0
          fi

          echo "Triggering GitHub Pages workflow in ${REPORTS_REPO}..."

          PAGES_URL="https://api.github.com/repos/${REPORTS_REPO}"
          PAGES_URL="${PAGES_URL}/actions/workflows/pages.yaml/dispatches"

          if curl -sS -X POST \
            -H "Authorization: Bearer ${REPORTS_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${PAGES_URL}" \
            -d '{"ref":"main"}'; then
            echo "âœ… Successfully triggered GitHub Pages workflow"
            {
              echo ""
              echo "### ðŸŒ GitHub Pages Update"
              echo "GitHub Pages workflow has been triggered" \
                "to update the reports site."
              DEPLOY_URL="https://github.com/${REPORTS_REPO}"
              DEPLOY_URL="${DEPLOY_URL}/actions/workflows/pages.yaml"
              echo "View the deployment at: ${DEPLOY_URL}"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::error::Failed to trigger GitHub Pages workflow"
            echo "::error::Ensure GERRIT_REPORTS_PAT_TOKEN has" \
              "'actions: write' permission for ${REPORTS_REPO}"
            exit 1
          fi
